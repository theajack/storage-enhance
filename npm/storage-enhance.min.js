!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.StorageEnhance=t():e.StorageEnhance=t()}(this,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=3)}([function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("os")},function(e,t,r){"use strict";r.r(t);var n={name:"miniapp",count:function(){return this.keys().length},keys:function(){return wx.getStorageInfoSync().keys},get:function(e){var t=e.key;return wx.getStorageSync(t)},set:function(e){var t=e.key,r=e.value;try{return wx.setStorageSync(t,r),!0}catch(e){return!1}},remove:function(e){var t=e.key;try{return wx.removeStorageSync(t),!0}catch(e){return!1}},clear:function(){try{return wx.clearStorageSync(),!0}catch(e){return!1}},all:function(){for(var e=[],t=this.keys(),r=0,n=t.length;r<n;r++){var o=t[r],a=this.get({key:o});e.push({key:o,value:a})}return e},exist:function(e){var t=e.key;return-1!==this.keys().indexOf(t)}},o=Symbol("storage-empty"),a="object"==typeof window&&!!window&&!u(window.localStorage),i="object"==typeof wx&&!!wx;function u(e){return void 0===e}function c(e){if(null===e||"object"!=typeof e)return e;var t=Array.isArray(e)?[]:{};for(var r in e)e.hasOwnProperty(r)&&(t[r]=c(e[r]));return t}function f(e){if(null===e||"symbol"==typeof e)return o;var t=function(e){try{return JSON.parse(e)}catch(e){return null}}(e);return null===t?e:t}var s=a?"web":i?"miniapp":"node",y="local";function p(){return y}var v={date:Date,reg:RegExp};function l(e){var t=typeof e;if("object"===t){var r=function(e){if(!e)return"null";for(var t in v){var r=t,n=v[r];if(!u(n)&&e instanceof n)return r}return""}(e);if(r)return r}return t}"web"===s&&(v.html=HTMLElement);var g={name:"web",count:function(e){return d((void 0===e?{}:e).type).length},keys:function(e){return m({type:(void 0===e?{}:e).type})},get:function(e){var t=e.key;return d(e.type).getItem(t)},set:function(e){var t=e.key,r=e.value,n=e.type;try{return d(n).setItem(t,JSON.stringify(r)),!0}catch(e){return!1}},remove:function(e){var t=e.key,r=e.type;try{return d(r).removeItem(t),!0}catch(e){return!1}},clear:function(e){var t=(void 0===e?{}:e).type;try{return d(t).clear(),!0}catch(e){return!1}},all:function(e){for(var t=(void 0===e?{}:e).type,r=[],n=m({type:t}),o=d(t),a=0,i=n.length;a<i;a++){var u=n[a];r.push({key:u,value:o.getItem(u)})}return r},exist:function(e){var t=e.key;return d(e.type).hasOwnProperty(t)}};function d(e){return void 0===e&&(e=p()),"local"===e?window.localStorage:window.sessionStorage}function m(e){var t=e.type;return Object.keys(d(t))}var k={},h={},b={};"node"===s&&(k=r(0),h=r(1),b=r(2));var x="";if("node"===s){x=b.homedir();var S=h.resolve(x,"./storage-enhance-data");k.existsSync(S)||k.mkdirSync(S)}function w(e){var t=j(e);return k.existsSync(t)?k.readFileSync(j(e),"utf-8"):o}function j(e){return void 0===e&&(e=""),e&&(e="/"+e+".json"),h.resolve(x,"./storage-enhance-data"+e)}var O={function:{set:function(e){return"return ("+e.toString()+");"},get:function(e){return new Function(e)()}},reg:{set:function(e){return e.toString()},get:function(e){return new Function("return "+e)()}},html:{set:function(e){return e.outerHTML},get:function(e){var t=document.createElement("div");return t.innerHTML=e,t.children[0]}},date:{set:function(e){return e.getTime()},get:function(e){return new Date(e)}},symbol:{set:function(e){return e.toString()},get:function(e){return e.toString()}}};function P(e){var t=e.type,r=e.data,n=e.oprate,o=O[t];return o?o[n](r):r}var D={},T={name:"temp",count:function(){return this.keys().length},keys:function(){return Object.keys(D)},exist:function(e){var t=e.key;return D.hasOwnProperty(t)},get:function(e){var t=e.key;return this.exist({key:t})?c(D[t]):o},set:function(e){var t=e.key,r=e.value;return D[t]=c(r),!0},remove:function(e){var t=e.key;return delete D[t],!0},all:function(){return c(D)},clear:function(){return D={},!0}},E=[];function F(e){for(var t=e.options,r=e.storage,n=0,o=E;n<o.length;n++){var a=o[n];"function"==typeof a.beforeGet&&(t=a.beforeGet({options:t,storage:r}))}return t}var I={name:"times",get:function(e){var t=e.options,r=e.data,n=e.storage,a=e.key;if("number"!=typeof r.times)return r;if(r.times<=1){if($.remove(t),r.times<1)return o}else r.times-=1,n.set({key:a,value:r});return r},set:function(e){var t=e.options,r=e.data;t.once&&(t.times=1);var n=t.times;if("number"==typeof n){if(0===n)return!1;r.times=n}return r}};function C(e){var t=e.key,r=e.value,n=e.expires,o=e.path,a=e.domain,i=e.secure,u=e.sameSite,c=e.sameParty,f=e.priority,s=t+"="+escape(r)+";";n&&(s+="expires="+("number"==typeof n?new Date(n):n).toUTCString()+";");o&&(s+="path="+o+";"),a&&(s+="domain="+a+";"),i&&(s+="secure;"),u&&("None"!==u||i?s+="sameSite="+u+";":console.warn("设置sameSite=None时必须设置secure=true")),c&&(i?s+="sameParty;":console.warn("设置sameParty=true时必须设置secure=true")),f&&(s+="priority="+f+";");try{return document.cookie=s,!0}catch(e){return console.warn(e),!1}}var M={get:function(e){var t=e.key,r=document.cookie,n=new RegExp("(^| )"+t+"=([^;]*)(;|$)"),a=r.match(n);return a?unescape(a[2]):o},set:C,remove:function(e){var t,r=e;return r.expires=(t=-1e3,Date.now()+t),C(r)},checkPath:function(e){void 0===e&&(e="/");var t=e===location.pathname;return t||console.warn("Cookie 操作无效: path与当前pathname不一致; "+e+" - "+location.pathname),t},getCookieValuePairs:function(){var e=document.cookie;return""===e?[]:e.split(";")}},A=function(){return(A=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},G={name:"cookie",count:function(){return M.getCookieValuePairs().length},keys:function(){return M.getCookieValuePairs().map((function(e){return e.split("=")[0].trim()}))},get:function(e){var t=e.key;return f(M.get({key:t}))},set:function(e){var t=e.key,r=e.value,n=e.cookie;try{return M.set(A({key:t,value:JSON.stringify(r)},n)),!0}catch(e){return!1}},remove:function(e){var t=e.key,r=e.cookie;return M.remove(A({key:t},r))},clear:function(e){for(var t=(void 0===e?{}:e).cookie,r=this.keys(),n=0,o=r.length;n<o;n++)this.remove(A({key:r[n]},t));return!0},all:function(){var e=[];return M.getCookieValuePairs().forEach((function(t){var r=t.split("=");e.push({key:r[0].trim(),value:f(decodeURIComponent(r[1]))})})),e},exist:function(e){var t=e.key;return-1!==this.keys().indexOf(t)}};function N(e){return e<Date.now()}var _={name:"expires",get:function(e){var t=e.options,r=e.data,n=e.storage;return"cookie"===n.name||"number"!=typeof r.expires?r:N(r.expires)?(n.remove(t),o):r},set:function(e){var t=e.options,r=e.data;if("cookie"===e.storage.name)return"number"==typeof t.expires&&("object"==typeof t.cookie?t.cookie.expires=t.expires:t.cookie={expires:t.expires}),r;if("number"==typeof t.expires){if(N(t.expires))return!1;r.expires=t.expires}return r}},L={};function J(){return L}function R(e){return"string"==typeof e?"@:"+e:P({data:e,type:"function",oprate:"set"})}var V={name:"event",get:function(e){var t=e.data,r=e.onFinalData;return t.onGet?(r((function(e){q(t.onGet,e)})),t):t},set:function(e){var t=e.options,r=e.data,n=e.prevData;return t.onGet&&(r.onGet=R(t.onGet)),"object"==typeof n&&q(n.onSet,r.value,n.value),t.onSet&&(r.onSet=R(t.onSet),q(r.onSet,r.value,o)),r},remove:function(e){var t=e.prevData;return"object"==typeof t&&q(t.onRemove,t.value),!0}};function q(e,t,r){if(void 0!==e){var n=function(e){if(0===e.indexOf("@:")){var t=e.substring(2),r=J();return"function"==typeof r[t]?r[t]:null}return new Function(e)()}(e);null!==n?n({scope:J(),data:t,prevData:r}):console.warn("Invalid event:",e)}}var H={name:"final",set:function(e){var t=e.options,r=e.data,n=e.prevData;return"object"==typeof n&&!0===n.final?(console.warn("Final 类型禁止设置新的值："+t.key),!1):("boolean"==typeof t.final&&(r.final=t.final),r)}},U=function(){return(U=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},Y={web:g,miniapp:n,node:{name:"node",count:function(){return this.keys().length},keys:function(){var e=j();console.log(e);var t=k.readdirSync(e);console.log(t);for(var r=[],n=0,o=t;n<o.length;n++){var a=o[n],i=a.lastIndexOf(".json");-1!==i&&r.push(a.substring(0,i))}return r},exist:function(e){var t=j(e.key);return k.existsSync(t)},get:function(e){return f(w(e.key))},set:function(e){var t=e.key,r=e.value,n=j(t);return console.log(n),k.writeFileSync(n,JSON.stringify(r)),!0},remove:function(e){var t=j(e.key);if(k.existsSync(t))try{return k.rmSync(t),!0}catch(e){return!1}return!1},all:function(){for(var e=this.keys(),t=[],r=0,n=e.length;r<n;r++){var o=e[r],a=f(w(o));t.push({key:o,value:a})}return t},clear:function(){var e=j();return k.rmdirSync(e),k.mkdirSync(e),!0}}}[s];function K(e){return void 0===e&&(e=p()),"web"===s&&"cookie"===e?G:"temp"===e||"web"!==s&&"local"!==e?T:Y}var $={EMPTY:o,use:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];E.push.apply(E,e)},plugins:function(){return E},registScope:function(e,t){"string"==typeof e?L[e]=t:Object.assign(L,e)},scope:J,env:s,TYPE:{LOCAL:"local",SESSION:"session",TEMP:"temp",COOKIE:"cookie"},get type(){return p()},set type(e){!function(e){y=e}(e)},count:function(e){var t=(void 0===e?{}:e).type,r=K(t);return"cookie"===r.name?r.count({type:t}):r.keys({type:t}).length},keys:function(e){var t=(void 0===e?{}:e).type;return K(t).keys({type:t})},clear:function(e){void 0===e&&(e={});var t=e.type;if(!e.protect)return K(t).clear(e);for(var r=!0,n=0,o=this.keys({type:t});n<o.length;n++){var a=o[n];this.remove(a,e)||(r=!1)}return r},remove:function(e,t){if(void 0===t&&(t={key:""}),"object"==typeof e)return $.remove(e.key,e);var r=t.type;if(""===e)return!0;t.key=e;var n=K(r);e=(t=F({storage:n,options:t})).key;var o=f(n.get(U(U({},t),{key:e})));if("string"!=typeof o){if("symbol"==typeof o)return!0;if(console.warn("[prev]",o,t,t),!1===function(e){for(var t=0,r=E;t<r.length;t++){var n=r[t];if("function"==typeof n.remove)if(!1===n.remove(e))return!1}return!0}({options:t,storage:n,prevData:o}))return!1}return n.remove(U(U({},t),{key:e}))},exist:function(e,t){if(void 0===t&&(t={key:""}),"object"==typeof e)return this.exist(e.key,e);var r=t.key,n=t.type;return K(n).exist({key:r,type:n})},set:function(e,t,r){if(void 0===r&&(r={value:"",key:""}),"string"==typeof e){var n=r.type,o=r.cookie,a=e;if(r.key=a,""===a)return!1;var i=function(e){var t=e.data,r=e.storageType,n=void 0===r?"local":r,o=l(t);return{type:o,value:"temp"===n?t:P({type:o,data:t,oprate:"set"})}}(U({data:t,storageType:n},o)),u=K(n),c=u.get({key:a,type:n}),s=function(e){for(var t=0,r=E;t<r.length;t++){var n=r[t];if("function"==typeof n.set){var o=n.set(e);if("boolean"==typeof o)return o;e.data=o}}return e.data}({options:r,data:i,storage:u,prevData:f(c)});return"boolean"==typeof s?s:(console.log("executePluginsSet result",i),u.set(U(U({},r),{key:r.key,value:s})))}if(Array.isArray(e)){for(var y=!0,p=0,v=e;p<v.length;p++){var g=v[p];this.set(g)||(y=!1)}return y}if("object"==typeof e){a=e.key;var d=e.value;return this.set(a,d,e)}throw new Error("Invalid set")},get:function(e){if(Array.isArray(e)){for(var t=[],r=0,n=e;r<n.length;r++){var a=n[r];t.push(this.get(a))}return t}if("object"==typeof e){var i=e.type,u=e.detail;if(""===e.key)return o;var c=K(i),s=(e=F({storage:c,options:e})).key,y=f(c.get({key:s,type:i}));if(!function(e){return"object"==typeof e}(y))return o;var p=(g=null,{onFinalData:function(e){g=e},trigFinalData:function(e){"function"==typeof g&&g(e)}}),v=p.trigFinalData;if("symbol"==typeof(y=function(e){for(var t=0,r=E;t<r.length;t++){var n=r[t];if("function"==typeof n.get){var a=n.get(e);if("symbol"==typeof a)return o;e.data=a}}return e.data}({options:e,data:y=y,storage:c,key:s,onFinalData:p.onFinalData})))return o;var l=function(e){var t=e.data,r=e.storageType;return"temp"===(void 0===r?"local":r)?t.value:P({type:t.type,data:t.value,oprate:"get"})}({storageType:e.type,data:y});return v(l),u?y:l}var g;return this.get({key:e})},all:function(e){var t=this,r=void 0===e?{}:e,n=r.type,o=r.detail;return this.keys({type:n}).map((function(e){return t.get({key:e,type:n,detail:o})}))}};$.use(H,{name:"protect",set:function(e){var t=e.options,r=e.data;return"boolean"==typeof t.protect&&(r.protect=t.protect),r},remove:function(e){var t=e.prevData,r=e.options;return!("object"==typeof t&&!r.protect)||!0!==t.protect}},I,_,V);t.default=$}]).default}));